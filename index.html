<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.2">
	<title>Petz Paletteaire</title>
	<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Press Start 2P';
			font-size: 1.0em;
			background-color: #2f2f2f;
			color: #e0e0e0;
			margin: 5px;
			padding: 5px;
		}
	
		.note {
			font-family: 'Roboto Mono';
			font-size: 0.8em;
			color: #e0e0e0;
		}
	
		h1 {
			font-size: 1.2em;
			color: #ffffff;
			text-align: center;
			text-shadow: 2px 2px 4px #000000;
		}
	
		h2 {
			font-size: 1.1em;
			color: #ffffff;
			text-align: center;
			text-shadow: 2px 2px 4px #000000;
		}

		p {
			font-family: 'Roboto Mono';
		}
	
		a:link,
		a:visited {
			color: #00bfa5;
			text-decoration: none;
		}
	
		a:hover {
			color: #1de9b6;
			text-decoration: underline;
		}
	
		a:active {
			color: #00bfa5;
		}

		.widget-container {
			background-color: #1a1a1a;
			border: 2px solid #444;
			border-radius: 12px;
			padding: 1.5em;
			margin: 1.5em auto;
			max-width: 640px;
			box-shadow: 0 0 12px #000;
		}

		.widget-container h2 {
			margin-top: 0;
			color: #00bfa5;
			font-size: 1em;
			text-align: center;
		}

		.widget-section {
			margin: 1em 0;
		}

		label {
			display: block;
			margin: 1em 0;
			color: #e0e0e0;
		}

		input[type="file"] {
			display: block;
			margin-top: 0.3em;
		}

		button {
			margin-top: 1em;
			font-family: 'Press Start 2P', monospace;
			font-size: 0.7em;
			padding: 0.5em 1em;
			color: #fff;
			background-color: #0e9c89;
			border: none;
			border-radius: 6px;
			cursor: pointer;
		}

		button:hover {
			background-color: #00bfa5;
		}

		select {
			font-family: 'Roboto Mono', monospace;
			font-size: 0.8em;
			color: #fff;
			background-color: #1a1a1a;
			border: 1px solid #444;
			border-radius: 6px;
			padding: 0.5em;
			width: 100%;
			box-shadow: 2px 2px 4px #000;
		}

		input {
			margin-top: 1em;
			font-family: 'Press Start 2P', monospace;
			font-size: 0.7em;
			padding: 0.5em 1em;
			color: #fff;
			background-color: #00bfa5;
			border: none;
			border-radius: 6px;
			cursor: pointer;
		}

		input:hover {
			background-color: #1de9b6;
		}

		#links a {
			display: inline-block;
			margin: 0.3em;
			font-size: 0.75em;
		}

		.input-wrapper {
			position: relative;
			display: inline-block;
			width: 100%;
			margin-top: 0.5em;
		}

		.input-wrapper input[type="file"] {
			position: absolute;
			left: 0;
			top: 0;
			opacity: 0;
			width: 100%;
			height: 100%;
			cursor: pointer;
		}

		.input-wrapper .button-style {
			background-color: #00bfa5;
			color: #000;
			border: none;
			border-radius: 6px;
			padding: 0.5em 1em;
			font-family: 'Press Start 2P', monospace;
			font-size: 0.7em;
			cursor: pointer;
			display: inline-block;
			text-align: center;
			width: 100%;
			box-shadow: 2px 2px 0 #004d40;
		}

		.input-wrapper .button-style:hover {
			background-color: #1de9b6;
		}

		.preview-grid {
			display: flex;
			flex-wrap: wrap;
			gap: 1em;
			margin-top: 1em;
		}

		.preview-grid canvas {
			border: 1px solid #555;
			background: #111;
			width: auto;
			height: 100px;
			image-rendering: pixelated;
		}

		.preview-grid img {
			border: 1px solid #444;
			background: #000;
			max-width: 100px;
			height: auto;
			image-rendering: pixelated;
			cursor: zoom-in;
			transition: transform 0.1s ease;
		}

		.preview-grid img.enlarged {
			width: auto;
			height: auto;
			max-width: none;
			max-height: none;
			z-index: 1000;
			border: 2px solid #888;
			background: #000;
			cursor: zoom-out;
			image-rendering: pixelated;
			position: relative;
		}

		.preview-item { text-align:center; max-width:110px; }
		.preview-item p { margin:0.2em 0 0; font-size:0.6em; }

		#sidebar {
			position: fixed;
			bottom: 20px;
			left: 20px;
			background-color: #1a1a1a;
			border: 3px double #00bfa5;
			border-radius: 16px 16px 16px 16px;
			padding: 1em 1.2em;
			z-index: 100;
			max-width: 180px;
			text-align: center;
		}

		#sidebar a {
			display: block;
			margin: 0.4em 0;
			font-size: 0.65em;
			color: #0e9c89;
			text-decoration: none;
			font-family: 'Press Start 2P', monospace;
		}

		#sidebar a:hover {
			color: #1de9b6;
			text-decoration: underline;
		}

	</style>
</head>

<body>
	<div id="sidebar">
		<a href="#header-input">Input</a>
		<a href="#header-options">Options</a>
		<a href="#header-palettes">Palettes</a>
		<a href="#header-list">List</a>
		<a href="#header-preview">Previews</a>
		<a href="#header-downloads">Downloads</a>
	</div>	

	<h1>Petz Paletteiare</h1>
	<h2>v1.3</h2>
	<p>A handy web app for swapping palettes in bulk!</p>
	<p>- Kathleen @ <a href="https://www.tabbloza.com/petz">Tabbloza</a></p>

	<div class="widget-container">
		<h2 id="header-input">Bulk Palette Swap</h2>
		<p>Select a folder of palettes, and optionally, a folder of PNG images that you would like to recolor:</p>
		<div class="widget-section">
			<div class="input-wrapper">
				<span class="button-style">Choose Palette Folder</span>
				<input type="file" id="palDir" webkitdirectory directory multiple>
			</div>

			<div class="input-wrapper">
				<span class="button-style">Choose PNG Folder</span>
				<input type="file" id="imgDir" webkitdirectory directory multiple accept=".png">
			</div>

			<p>To swap palettes on your images, you need to specify which palette is used by those images. For example, if your game has "reshade" as the default palette, then your petz pics will be paletted and you need to provide "reshade.bmp" in your palette folder and select it below. The default Petz palette is built-in!</p>
			
			<div class="input-wrapper">
				<select id="paletteSelect">
					<option value="__default__">Use base Petz palette</option>
				</select>
				<div id="paletteViewer">
					<h3 id="header-palettes">Palettes</h3>
					<div id="paletteSwatches" style="display:flex;flex-wrap:wrap;margin-top:0.5em;"></div>
				</div>
				<button onclick="toggleViewer()">Toggle Palette Viewer</button>
			</div>			

			<!-- <div class="input-wrapper">
				<span class="button-style">Choose Base Palette</span>
				<input type="file" id="basePal" accept=".bmp,.act,.pal,.png">
			</div> -->
			
			<button id="run">Swap Palettes</button>
		</div>
		<div class="widget-section">
			<h3 id="header-options">Options</h3>
			<select id="sortOption"></select>

			<h3 id="header-list">List</h3>
			<p>See the list of palettes selected below:</p>
			<textarea id="palOut" rows="6" style="width:100%;font-family:'Roboto Mono';font-size:0.7em;"></textarea>

			<h3 id="header-preview">Previews</h3>
			<div id="preview" class="preview-grid"></div>

			<h3 id="header-downloads">Downloads</h3>
			<button id="downloadAll" style="display:none;">Download All</button>
			<div id="links"></div>
		</div>
	</div>

	<script>
		const $ = id => document.getElementById(id);

		const defaultPalette = [
				[255, 255, 255],
				[128, 0, 0],
				[0, 128, 0],
				[128, 128, 0],
				[0, 0, 128],
				[128, 0, 128],
				[0, 128, 128],
				[192, 192, 192],
				[192, 204, 216],
				[0, 0, 0],
				[231, 226, 221],
				[226, 220, 215],
				[221, 215, 210],
				[215, 209, 204],
				[210, 204, 199],
				[205, 198, 193],
				[200, 193, 188],
				[194, 187, 182],
				[189, 182, 177],
				[184, 176, 171],
				[117, 117, 117],
				[112, 112, 112],
				[107, 107, 107],
				[102, 102, 102],
				[97, 97, 97],
				[92, 92, 92],
				[87, 87, 87],
				[82, 82, 82],
				[77, 77, 77],
				[69, 69, 69],
				[66, 66, 66],
				[61, 61, 61],
				[54, 54, 54],
				[48, 48, 48],
				[41, 41, 41],
				[36, 36, 36],
				[28, 28, 28],
				[23, 23, 23],
				[15, 15, 15],
				[7, 7, 7],
				[220, 194, 150],
				[214, 186, 143],
				[208, 179, 137],
				[202, 171, 130],
				[196, 164, 124],
				[190, 156, 117],
				[184, 149, 111],
				[178, 141, 104],
				[172, 134, 98],
				[166, 126, 91],
				[135, 65, 34],
				[127, 60, 33],
				[120, 54, 31],
				[112, 49, 30],
				[104, 43, 28],
				[97, 38, 27],
				[89, 32, 25],
				[81, 27, 24],
				[74, 21, 22],
				[66, 16, 21],
				[180, 115, 22],
				[179, 110, 20],
				[176, 102, 17],
				[170, 94, 14],
				[167, 87, 12],
				[160, 79, 8],
				[157, 72, 7],
				[149, 64, 4],
				[146, 57, 2],
				[138, 48, 0],
				[240, 158, 183],
				[236, 152, 181],
				[231, 146, 182],
				[225, 137, 180],
				[219, 132, 180],
				[214, 128, 179],
				[205, 121, 177],
				[199, 117, 177],
				[191, 115, 176],
				[180, 110, 171],
				[168, 41, 1],
				[162, 37, 4],
				[156, 34, 7],
				[149, 30, 9],
				[143, 27, 12],
				[137, 23, 15],
				[131, 20, 18],
				[124, 16, 20],
				[118, 13, 23],
				[112, 9, 26],
				[107, 74, 12],
				[106, 68, 12],
				[101, 59, 11],
				[96, 52, 11],
				[91, 44, 11],
				[86, 38, 11],
				[82, 32, 10],
				[77, 27, 10],
				[72, 21, 9],
				[66, 16, 9],
				[166, 138, 56],
				[168, 137, 56],
				[163, 129, 56],
				[159, 123, 56],
				[154, 116, 55],
				[150, 110, 54],
				[145, 104, 54],
				[141, 98, 53],
				[136, 93, 53],
				[131, 87, 52],
				[98, 112, 125],
				[93, 105, 118],
				[87, 99, 112],
				[82, 92, 105],
				[77, 86, 99],
				[71, 79, 92],
				[66, 73, 86],
				[61, 66, 79],
				[55, 60, 73],
				[50, 53, 66],
				[154, 142, 115],
				[150, 137, 110],
				[142, 128, 103],
				[136, 121, 99],
				[127, 112, 92],
				[121, 106, 88],
				[112, 97, 81],
				[106, 91, 77],
				[98, 82, 71],
				[88, 74, 65],
				[66, 182, 68],
				[60, 174, 62],
				[52, 162, 54],
				[44, 150, 46],
				[36, 137, 38],
				[36, 128, 32],
				[35, 114, 26],
				[36, 99, 20],
				[33, 85, 15],
				[32, 69, 11],
				[17, 89, 223],
				[16, 80, 209],
				[15, 69, 194],
				[14, 61, 180],
				[12, 51, 166],
				[11, 37, 152],
				[10, 22, 138],
				[9, 11, 124],
				[14, 7, 110],
				[19, 6, 96],
				[216, 240, 255],
				[172, 224, 255],
				[153, 214, 255],
				[130, 202, 255],
				[117, 182, 232],
				[104, 192, 255],
				[81, 150, 220],
				[24, 156, 206],
				[86, 139, 185],
				[30, 137, 169],
				[235, 237, 167],
				[234, 235, 144],
				[209, 204, 119],
				[247, 244, 0],
				[237, 232, 50],
				[198, 198, 12],
				[195, 195, 52],
				[159, 162, 23],
				[159, 159, 67],
				[110, 122, 46],
				[255, 255, 255],
				[192, 228, 231],
				[172, 198, 213],
				[167, 167, 177],
				[160, 160, 168],
				[116, 160, 182],
				[119, 158, 180],
				[122, 156, 179],
				[125, 154, 178],
				[128, 152, 176],
				[226, 190, 172],
				[213, 147, 144],
				[215, 118, 110],
				[184, 115, 103],
				[159, 119, 115],
				[162, 106, 93],
				[137, 100, 88],
				[152, 87, 77],
				[106, 69, 66],
				[90, 60, 49],
				[114, 158, 140],
				[0, 128, 128],
				[66, 122, 117],
				[0, 128, 128],
				[57, 120, 96],
				[61, 90, 99],
				[38, 88, 71],
				[33, 65, 43],
				[18, 57, 48],
				[255, 255, 255],
				[255, 255, 255],
				[244, 246, 216],
				[233, 216, 194],
				[44, 95, 89],
				[211, 244, 197],
				[196, 211, 159],
				[255, 199, 26],
				[176, 184, 155],
				[175, 177, 119],
				[165, 148, 142],
				[172, 169, 143],
				[215, 160, 20],
				[198, 127, 8],
				[202, 110, 70],
				[121, 142, 97],
				[153, 126, 77],
				[128, 128, 128],
				[101, 155, 42],
				[0, 203, 22],
				[167, 108, 57],
				[255, 66, 0],
				[151, 100, 66],
				[153, 101, 42],
				[221, 52, 106],
				[41, 68, 117],
				[88, 105, 181],
				[66, 107, 132],
				[80, 100, 128],
				[117, 89, 74],
				[254, 24, 20],
				[110, 92, 43],
				[156, 66, 57],
				[184, 50, 66],
				[136, 68, 66],
				[85, 68, 127],
				[126, 140, 134],
				[207, 16, 12],
				[146, 25, 20],
				[255, 0, 254],
				[17, 40, 14],
				[13, 16, 41],
				[0, 0, 0],
				[0, 0, 0],
				[0, 0, 0],
				[0, 0, 0],
				[255, 255, 255],
				[80, 100, 128],
				[0, 0, 0],
				[128, 128, 128],
				[255, 0, 0],
				[0, 255, 0],
				[255, 255, 0],
				[0, 0, 255],
				[255, 0, 255],
				[0, 255, 255],
				[0, 0, 0]
			];

		let loadedPalettes = { "__default__": defaultPalette };
		let currentBasePalette = defaultPalette;

		const selectedPals = new Set();

		function updatePalOut() {
			$('palOut').value = Array.from(selectedPals).join('\n');
		}

		const dist = (a, b) => ((a[0] - b[0]) ** 2 + (a[1] - b[1]) ** 2 + (a[2] - b[2]) ** 2);
		const readBuf = f => new Promise(r => { const fr = new FileReader(); fr.onload = e => r(e.target.result); fr.readAsArrayBuffer(f); });
		const readImg = f => new Promise(r => { const fr = new FileReader(); fr.onload = e => { const i = new Image(); i.onload = () => r(i); i.src = e.target.result; }; fr.readAsDataURL(f); });

		async function parsePaletteFile(file) {
			const buffer = await file.arrayBuffer();
			const ext = file.name.split('.').pop().toLowerCase();
			const bytes = new Uint8Array(buffer);
			let palette = [];

			if (ext === 'act' || ext === 'pal') {
				// ACT/PAL: 768 bytes = 256 colors × 3 bytes
				if (bytes.length < 768) {
					console.error("ACT/PAL file too short, should be 768 bytes");
					return [];
				}
				for (let i = 0; i < 768; i += 3) {
					palette.push([bytes[i], bytes[i + 1], bytes[i + 2]]);
				}
			} else if (ext === 'bmp') {
				// BMP: Palette starts after 54 bytes (14 BMP header + 40 DIB header) for 8-bit indexed BMP
				// Each color is 4 bytes: B G R 00
				const bmpHeaderSize = 54;
				if (bytes.length < bmpHeaderSize + 256 * 4) {
					console.error("BMP file too small for full palette");
					return [];
				}
				for (let i = bmpHeaderSize; i < bmpHeaderSize + 256 * 4; i += 4) {
					palette.push([bytes[i + 2], bytes[i + 1], bytes[i]]);
				}
			} else if (ext === 'png') {
				// PNG: Find PLTE chunk (contains from 1 to 256 palette entries) after 8-byte PNG signature
				let offset = 8;
				while (offset < bytes.length) {
					const length = (bytes[offset] << 24) | (bytes[offset + 1] << 16) | (bytes[offset + 2] << 8) | bytes[offset + 3];
					const type = String.fromCharCode(...bytes.slice(offset + 4, offset + 8));
					if (type === 'PLTE') {
						for (let i = offset + 8; i < offset + 8 + length; i += 3) {
							palette.push([bytes[i], bytes[i + 1], bytes[i + 2]]);
						}
						break;
					}
					offset += 8 + length + 4;
				}
			}

			return palette.slice(0, 256);
		}

		function updatePaletteDropdown() {
			const sel = $('paletteSelect');
			sel.innerHTML = '';

			const defaultOpt = document.createElement('option');
			defaultOpt.value = '__default__';
			defaultOpt.textContent = 'Use base Petz palette';
			sel.appendChild(defaultOpt);

			const names = Object.keys(loadedPalettes).filter(k => k !== '__default__');
			for (const name of names) {
				const opt = document.createElement('option');
				opt.value = name;
				opt.textContent = name;
				sel.appendChild(opt);
			}

			sel.onchange = () => {
				currentBasePalette = loadedPalettes[sel.value];
				renderPaletteSwatches();
			};

			sel.dispatchEvent(new Event('change'));
		}

		function renderPaletteSwatches() {
			const name = $('paletteSelect').value;
			const pal = loadedPalettes[name];
			const container = $('paletteSwatches');
			container.innerHTML = '';
			pal.forEach((rgb, i) => {
				const swatch = document.createElement('div');
				swatch.style = `
					width: 20px; height: 20px;
					background: rgb(${rgb.join(',')});
					border: 1px solid #333;
					margin: 1px;
					font-size: 0.5em;
					color: #fff;
					text-align: center;
					line-height: 20px;
				`;
				swatch.textContent = i;
				container.appendChild(swatch);
			});
		}

		function toggleViewer() {
			const p = $('paletteViewer');
			p.style.display = p.style.display === 'none' ? 'block' : 'none';
		}

		function indexImage(img, basePal) {
			const cv = document.createElement('canvas');
			cv.width = img.width; cv.height = img.height;
			const cx = cv.getContext('2d'); cx.drawImage(img, 0, 0);
			const id = cx.getImageData(0, 0, cv.width, cv.height), d = id.data;
			const idx = [], alpha = [];
			for (let p = 0; p < d.length; p += 4) {
				let best = 0, m = 1e9;
				for (let i = 0; i < 256; i++) {
					const dd = dist([d[p], d[p + 1], d[p + 2]], basePal[i]);
					if (dd < m) { m = dd; best = i; }
				}
				idx.push(best);
				alpha.push(d[p + 3]);
			}
			return { idx, alpha, w: cv.width, h: cv.height };
		}

		function drawIndexed({ idx, alpha, w, h }, pal) {
			const cv = document.createElement('canvas');
			cv.width = w; cv.height = h;
			const cx = cv.getContext('2d');
			const id = cx.createImageData(w, h);
			for (let i = 0; i < idx.length; i++) {
				const [r, g, b] = pal[idx[i]];
				const o = i * 4;
				id.data[o] = r;
				id.data[o + 1] = g;
				id.data[o + 2] = b;
				id.data[o + 3] = alpha[i]; // use original alpha
			}
			cx.putImageData(id, 0, 0);
			return cv;
		}

		function renderPreviewsSorted() {
			const raw = $('sortOption').value.replace(/ /g, '').toLowerCase();
			const key = metricKey[raw];
			const items = [...cachedPreviews];

			if (key) {
				items.sort((a, b) => a.metrics[key] - b.metrics[key]);
			} else {
				items.sort((a, b) => a.pName.localeCompare(b.pName));
			}

			const container = $('preview');
			container.innerHTML = '';
			items.forEach(({ wrapper }) => container.appendChild(wrapper));
		}

		const sortSelect = document.getElementById('sortOption');
		['alphabetical', 'mean hue', 'median hue', 'dominant hue', 'dark to light', 'muted to vivid', 'warm to cool'].forEach(option => {
			const o = document.createElement('option');
			o.value = option;
			o.textContent = option;
			sortSelect.appendChild(o);
		});
		sortSelect.value = 'alphabetical';

		const paletteMetrics = {};

		const metricKey = {
			alphabetical: null,
			meanhue: 'meanHue',
			medianhue: 'medianHue',
			dominanthue: 'dominantHue',
			darktolight: 'meanVal',
			mutedtovivid: 'meanSat',
			warmtocool: 'warmness'
		};

		function computeMetrics(name, pal) {
			const hues = [], sats = [], vals = [];

			for (const [r, g, b] of pal) {
				const [h, s, v] = rgbToHsv(r, g, b);
				if (!isNaN(h)) hues.push(h);
				sats.push(s);
				vals.push(v);
			}

			const hueCounts = hues.reduce((acc, h) => {
				const k = Math.round(h);
				acc[k] = (acc[k] || 0) + 1;
				return acc;
			}, {});
			const dominantHue = +Object.entries(hueCounts)
				.sort((a, b) => b[1] - a[1])[0][0] || 0;

			paletteMetrics[name] = {
				meanHue: avg(hues),
				medianHue: median(hues),
				dominantHue,
				meanSat: avg(sats),
				meanVal: avg(vals),
				warmness: avg(hues.map(h => (h < 180 ? h : 360 - h)))
			};
		}

		function makePreviewMetrics(canvas, pal) {
			const ctx = canvas.getContext('2d');
			const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);

			const hues = [], sats = [], vals = [];

			for (let i = 0; i < data.length; i += 4) {
				const a = data[i + 3];
				if (a === 0) continue; // skip transparent pixels

				const r = data[i], g = data[i + 1], b = data[i + 2];
				const [h, s, v] = rgbToHsv(r, g, b);
				if (!isNaN(h)) hues.push(h);
				sats.push(s);
				vals.push(v);
			}

			const hueCounts = hues.reduce((acc, h) => {
				const key = Math.round(h);
				acc[key] = (acc[key] || 0) + 1;
				return acc;
			}, {});
			const dominantHue = +Object.entries(hueCounts).sort((a, b) => b[1] - a[1])[0][0];

			return {
				meanHue: avg(hues),
				medianHue: median(hues),
				dominantHue,
				meanSat: avg(sats),
				meanVal: avg(vals),
				warmness: avg(hues.map(h => h < 180 ? h : 360 - h))
			};
		}

		function rgbToHsv(r, g, b) {
			r /= 255; g /= 255; b /= 255;
			const max = Math.max(r, g, b), min = Math.min(r, g, b);
			const v = max;
			const d = max - min;
			const s = max === 0 ? 0 : d / max;
			let h = 0;
			if (d !== 0) {
				switch (max) {
					case r: h = ((g - b) / d + (g < b ? 6 : 0)); break;
					case g: h = ((b - r) / d + 2); break;
					case b: h = ((r - g) / d + 4); break;
				}
				h *= 60;
			}
			return [h, s, v];
		}

		function avg(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }

		function median(arr) {
			const s = [...arr].sort((a, b) => a - b);
			const mid = Math.floor(s.length / 2);
			return s.length % 2 ? s[mid] : (s[mid - 1] + s[mid]) / 2;
		}

		$('palDir').addEventListener('change', async () => {
			const pals = $('palDir').files;
			loadedPalettes = { '__default__': defaultPalette };
			paletteMetrics['__default__'] = { meanHue: 0, medianHue: 0, dominantHue: 0, meanSat: 0, meanVal: 0, warmness: 0 };
			for (const f of pals) {
				const name = f.name.replace(/\.[^.]+$/, '');
				const parsed = await parsePaletteFile(f);
				if (parsed.length === 256) {
					loadedPalettes[name] = parsed;
					computeMetrics(name, parsed);
				}
			}
			updatePaletteDropdown();
		});

		let cachedPreviews = [];

		$('run').onclick = async () => {
			const imgs = $('imgDir').files
			// const pals = $('palDir').files
			// const baseFile = $('basePal').files[0]
			$('links').innerHTML = ''
			$('preview').innerHTML = ''
			// if (!imgs.length || !baseFile || !pals.length) return
			if (!imgs.length) { alert('No PNG images selected'); return; }
			if (Object.keys(loadedPalettes).length === 1) {         // only "__default__"
				alert('Load at least one palette first!');
				return;
			}

			const sortKey = $('sortOption').value.replace(/ /g, '');
			const palNames = Object.keys(loadedPalettes)
				.filter(p => p !== '__default__')
				.sort((a, b) => paletteMetrics[a][sortKey] - paletteMetrics[b][sortKey]);

			// const basePal = await parsePaletteFile(baseFile)
			// if (basePal.length !== 256) { alert('Base palette must have 256 colours'); return }

			// const palMap = {}
			// for (const f of pals) palMap[f.name.replace(/\.[^.]+$/, '')] = await parsePaletteFile(f)

			const palMap = loadedPalettes;

			cachedPreviews = [];

			for (const imgF of imgs) {
				const img = await readImg(imgF)
				const indexed = indexImage(img, currentBasePalette)
				for (const pName of palNames) {
					const pal = palMap[pName];
				// for (const [pName, pal] of Object.entries(palMap)) {
					if (pName === '__default__') continue;
					if (pal.length !== 256) continue
					const cv = drawIndexed(indexed, pal)
					const blob = await new Promise(r => cv.toBlob(r, 'image/png'))
					const url = URL.createObjectURL(blob)
					const a = document.createElement('a')
					a.href = url
					a.download = `${pName}_${imgF.name}`
					a.textContent = a.download
					a.className = 'dl'
					$('links').appendChild(a)
					const wrapper = document.createElement('div');

					wrapper.className = 'preview-item';

					const thumb = new Image();
					thumb.src = url;
					thumb.onclick = () => {
						document.querySelectorAll('.preview-grid img.enlarged')
							.forEach(el => el !== thumb && el.classList.remove('enlarged'));
						thumb.classList.toggle('enlarged');
					};
					thumb.style.imageRendering = 'pixelated';
					wrapper.appendChild(thumb);

					const label = document.createElement('p');
					label.textContent = pName;
					wrapper.appendChild(label);

					const cb = document.createElement('input');
					cb.type = 'checkbox';
					cb.onchange = e => {
						e.target.checked ? selectedPals.add(pName) : selectedPals.delete(pName);
						updatePalOut();
					};
					wrapper.appendChild(cb);

					// $('preview').appendChild(wrapper);
					const metrics = makePreviewMetrics(cv, pal);
					cachedPreviews.push({ pName, wrapper, metrics });
				}
			}

			renderPreviewsSorted();

			$('downloadAll').style.display = 'inline-block';
		};

		$('downloadAll').onclick = () => {
				document.querySelectorAll('#links a.dl').forEach(a => a.click());
			};

		$('sortOption').onchange = renderPreviewsSorted;
	</script>
</body>

</html>